---
import Layout from '~/layouts/PageLayout.astro'

const artworks = [
  { artist: "Anyang", discord: "Anyang", image: "/FANART/Anyang.webp" },

  // رسمتين من MARIYO
  { artist: "Mariyo", discord: "Mariyo", image: "/FANART/Mariyo.webp" },
  { artist: "Mariyo", discord: "Mariyo", image: "/FANART/Mariyo.png" },

  { artist: "NORH", discord: "NORH", image: "/FANART/NORH.webp" },
  { artist: "kanai", discord: "kanai", image: "/FANART/kanai.webp" },
  { artist: "pekz0", discord: "pekz0", image: "/FANART/pekz0.webp" },
]
---

<Layout metadata={{ title: "معرض الرسمات — TNX6", ignoreTitleTemplate: true }}>
  <section class="py-24 px-6 text-white">
    <h1
      class="text-5xl font-extrabold text-center mb-12 bg-gradient-to-r from-[#ffda6a] to-[#c29200] bg-clip-text text-transparent drop-shadow-[0_0_10px_rgba(198,164,79,0.5)]"
    >
      معرض الرسمات
    </h1>

    <div class="fanart-grid grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8 max-w-5xl mx-auto">
      {artworks.map((a) => (
        <div
          class="fanart-card group relative overflow-hidden rounded-3xl bg-black/30 border border-transparent
                 shadow-lg backdrop-blur-sm cursor-pointer transition-transform will-change-transform hover:scale-[1.02]"
          role="button"
          tabindex="0"
          data-src={a.image}
          data-artist={a.artist}
          data-discord={a.discord}
          aria-label={`Open fan art by ${a.artist}`}
        >
          <img
            src={a.image}
            alt={`Fan art by ${a.artist}`}
            loading="lazy"
            class="fanart-img w-full h-[240px] sm:h-[260px] object-cover transition-transform duration-200"
          />

          <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/10 to-transparent pointer-events-none"></div>

          <div
            class="absolute left-3 bottom-3 z-10 bg-black/60 backdrop-blur-md rounded-xl px-3 py-2 border border-white/10"
          >
            <div class="text-sm font-extrabold text-[#f7e6ac] leading-none">
              {a.artist}
            </div>
            <div class="text-xs text-[#f7e6ac]/75 mt-1 leading-none">
              @{a.discord}
            </div>
          </div>
        </div>
      ))}
    </div>
  </section>

  <!-- Popup -->
  <div
    id="popup"
    class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4"
    aria-hidden="true"
  >
    <div
      id="popupInner"
      class="popup-inner relative bg-black/55 border border-[#c6a44f]/40 rounded-2xl p-4
             shadow-[0_0_30px_rgba(198,164,79,0.35)] backdrop-blur-md w-[min(1200px,95vw)]"
    >
      <div class="flex items-start justify-between gap-3 mb-3">
        <div>
          <h2 id="popupName" class="text-2xl font-extrabold text-[#ffda6a] leading-tight"></h2>
          <p id="popupHandle" class="text-sm text-[#f7e6ac]/75"></p>
        </div>

        <button
          id="closePopup"
          class="w-11 h-11 rounded-xl bg-[#c29200]/40 hover:bg-[#ffda6a]/80 text-black font-black transition"
          type="button"
          aria-label="Close"
          title="Close"
        >
          ×
        </button>
      </div>

      <!-- Zoom stage -->
      <div
        id="zoomStage"
        class="relative w-full max-h-[78vh] rounded-xl bg-black/20 border border-white/10 overflow-hidden select-none"
      >
        <img
          id="popupImg"
          class="block w-full h-auto max-h-[78vh] object-contain"
          alt=""
          draggable="false"
        />
      </div>
    </div>
  </div>

  <style is:global>
    /* نفس الحد الذهبي (ثابت بدون دوران) */
    .fanart-card {
      position: relative;
      isolation: isolate;
      animation: fadeScale 400ms ease both;
    }

    .fanart-card::before {
      content: "";
      position: absolute;
      inset: -2px;
      padding: 2px;
      border-radius: 1.5rem;

      background: conic-gradient(
        from 0deg,
        #ffda6a,
        #c29200,
        #c6a44f,
        #ffda6a,
        #c29200
      );

      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;

      opacity: 0.75;
      pointer-events: none;
      z-index: -1;

      /* مافيه animation هنا */
      transform: none;
    }

    .fanart-card:hover {
      box-shadow:
        0 0 22px rgba(198, 164, 79, 0.55),
        0 0 44px rgba(198, 164, 79, 0.35);
    }

    /* Hover effect: الباقي ينطفي + يقل saturate + blur خفيف */
    @media (hover: hover) and (pointer: fine) {
      .fanart-grid:hover > .fanart-card:not(:hover) .fanart-img {
        filter: brightness(0.38) saturate(0.25) blur(6px) contrast(1.1);
        transform: scale(1.02);
      }
      .fanart-grid:hover > .fanart-card:hover .fanart-img {
        filter: saturate(1.15) contrast(1.05);
        transform: scale(1.06);
      }
    }

    .popup-inner.animate-in { animation: fadeScale 260ms ease both; }

    @keyframes fadeScale {
      from { opacity: 0; transform: scale(.96); }
      to   { opacity: 1; transform: scale(1); }
    }

    /* Zoom transforms via CSS vars */
    #zoomStage { cursor: zoom-in; }
    #zoomStage.is-zoomed { cursor: grab; }
    #zoomStage.is-dragging { cursor: grabbing; }

    #popupImg {
      transform-origin: var(--ox, 50%) var(--oy, 50%);
      transform: translate(var(--tx, 0px), var(--ty, 0px)) scale(var(--s, 1));
      transition: transform 140ms ease;
      will-change: transform;
    }
    #zoomStage.is-dragging #popupImg { transition: none; }
  </style>

  <script is:inline>
    const cards = document.querySelectorAll('.fanart-card');
    const popup = document.getElementById('popup');
    const popupInner = document.getElementById('popupInner');
    const popupImg = document.getElementById('popupImg');
    const popupName = document.getElementById('popupName');
    const popupHandle = document.getElementById('popupHandle');
    const closePopup = document.getElementById('closePopup');
    const zoomStage = document.getElementById('zoomStage');

    let scale = 1;
    let tx = 0, ty = 0;
    let isDragging = false;
    let lastX = 0, lastY = 0;

    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

    const applyTransform = () => {
      popupImg.style.setProperty('--s', scale);
      popupImg.style.setProperty('--tx', `${tx}px`);
      popupImg.style.setProperty('--ty', `${ty}px`);
      zoomStage.classList.toggle('is-zoomed', scale > 1);
    };

    const setOriginFromEvent = (e) => {
      const r = zoomStage.getBoundingClientRect();
      const ox = ((e.clientX - r.left) / r.width) * 100;
      const oy = ((e.clientY - r.top) / r.height) * 100;
      popupImg.style.setProperty('--ox', `${clamp(ox, 0, 100)}%`);
      popupImg.style.setProperty('--oy', `${clamp(oy, 0, 100)}%`);
    };

    const resetZoom = () => {
      scale = 1;
      tx = 0; ty = 0;
      popupImg.style.setProperty('--ox', `50%`);
      popupImg.style.setProperty('--oy', `50%`);
      zoomStage.classList.remove('is-zoomed', 'is-dragging');
      applyTransform();
    };

    const openPopup = (src, artist, discord) => {
      popupImg.src = src;
      popupImg.alt = `Fan art by ${artist}`;
      popupName.textContent = artist;
      popupHandle.textContent = `@${discord}`;

      popup.classList.remove('hidden');
      popup.classList.add('flex');
      popup.setAttribute('aria-hidden', 'false');

      popupInner.classList.remove('animate-in');
      void popupInner.offsetWidth;
      popupInner.classList.add('animate-in');

      resetZoom();
    };

    const close = () => {
      popup.classList.remove('flex');
      popup.classList.add('hidden');
      popup.setAttribute('aria-hidden', 'true');
      popupInner.classList.remove('animate-in');
      popupImg.src = '';
      popupImg.alt = '';
      resetZoom();
    };

    cards.forEach(card => {
      const { src, artist, discord } = card.dataset;
      card.addEventListener('click', () => openPopup(src, artist, discord));
      card.addEventListener('keyup', (e) => {
        if (e.key === 'Enter' || e.key === ' ') openPopup(src, artist, discord);
      });
    });

    closePopup.addEventListener('click', close);
    popup.addEventListener('click', (e) => { if (e.target === popup) close(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });

    // Left click: zoom in/out
    zoomStage.addEventListener('click', (e) => {
      if (popup.classList.contains('hidden')) return;

      if (scale === 1) {
        setOriginFromEvent(e);
        scale = 2.6;
        tx = 0; ty = 0;
        applyTransform();
      } else {
        resetZoom();
      }
    });

    // Drag to pan (only when zoomed)
    zoomStage.addEventListener('pointerdown', (e) => {
      if (scale <= 1) return;
      isDragging = true;
      zoomStage.classList.add('is-dragging');
      lastX = e.clientX;
      lastY = e.clientY;
      zoomStage.setPointerCapture(e.pointerId);
    });

    zoomStage.addEventListener('pointermove', (e) => {
      if (!isDragging) return;
      const dx = e.clientX - lastX;
      const dy = e.clientY - lastY;
      lastX = e.clientX;
      lastY = e.clientY;
      tx += dx;
      ty += dy;
      applyTransform();
    });

    zoomStage.addEventListener('pointerup', (e) => {
      if (!isDragging) return;
      isDragging = false;
      zoomStage.classList.remove('is-dragging');
      try { zoomStage.releasePointerCapture(e.pointerId); } catch {}
    });

    // Wheel zoom
    zoomStage.addEventListener('wheel', (e) => {
      if (popup.classList.contains('hidden')) return;
      e.preventDefault();

      setOriginFromEvent(e);

      const delta = Math.sign(e.deltaY);
      const step = 0.25;

      if (delta > 0) scale -= step;
      else scale += step;

      scale = clamp(scale, 1, 6);

      if (scale === 1) {
        tx = 0; ty = 0;
      }

      applyTransform();
    }, { passive: false });
  </script>
</Layout>
